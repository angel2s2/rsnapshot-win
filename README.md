# rsnapshot-win

На днях понадобилось организовать бэкапы с win на win, но места было мало. Бегло погуглил софт и варианты rsnapshot, но ничего простого не нашел. А заморачиваться с полноценным rsnapshot желания не было. Хотелось закинуть скрипт на комп, добавить в планировщик и готово.
Из этих мыслей и родился данный скрипт.

Проверял на win7 и win10.

# Настройки

В скрипте всего три настройки (думаю комментарии тут излишни :)
```batch
:: Источник
set "SRC=\\10.10.10.10\share"
:: Хранилище
set "DSTROOT=C:\bak"
:: Количества сохраняемых копий (обязательно >0)
set "MAX_COPIES=10"
```

Если у вас локаль не русская, то стоит подкорректировать скрипт под свою локаль, чтобы корректно обрабатывалась дата.  
В строках 17-21
```batch
for /f "tokens=1-3 delims=." %%a in ('date /t') do (
    set "DD=%%a"
    set "MM=%%b"
    set "YYYY=%%c"
)
```
нужно заменить точку на разделитель даты в вашей локали (например, "/").  
Так же скорее всего придется поменять порядок переменных.   
Например, для локали с форматом датой 2025/11/22 нужно будет подкорректировать на  
```batch
for /f "tokens=1-3 delims=/" %%a in ('date /t') do (
    set "YYYY=%%a"
    set "MM=%%b"
    set "DD=%%c"
)
```


# Как работает скрипт

Если в каталоге `%DSTROOT%` пусто, то скрипт считает, что это первое копирование и просто копирует с помощью `robocopy` всю папку (первый полный бэкап) в созданную им папку вида `ГГГГ-ММ-ДД_ЧЧ-ММ`.

Если в каталоге `%DSTROOT%` есть папки, то скрипт считает, что это 2+ запуск. Возьмет самую свежую папку из предыдущих бэкапов и сделает жесткие ссылки на все файлы в новую папку вида `ГГГГ-ММ-ДД_ЧЧ-ММ` с помощью `fsutil hardlink create`. Далее с помощью `robocopy` скопирует из источника все новые и измененные файлы и папки в новую папку вида `ГГГГ-ММ-ДД_ЧЧ-ММ`, заменяя имеющиеся там жесткие ссылки.

В процессе работы скрипт пишет лог в текущую папку бэкапа, т.е. `%DSTROOT%\ГГГГ-ММ-ДД_ЧЧ-ММ`. Файл `log_ГГГГ-ММ-ДД_ЧЧ-ММ.log`.

После бэкапа скрипт удаляет старые бэкапы, осталяя `%MAX_COPIES%` последних бэкапов.


# Баги

В логе местами бывает не корректная кодировка. 


# P.S.

Скрипт выкладываю как есть. Используйте на свой страх и риск.

